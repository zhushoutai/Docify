import os
import streamlit as st
import asyncio
from metagpt.actions import Action
from metagpt.roles import Role
from metagpt.schema import Message
from metagpt.logs import logger
import nest_asyncio
nest_asyncio.apply()

# å®šä¹‰å„ä¸ªæ–‡æ¡£ç”Ÿæˆçš„ Action ç±»
class ParseOutline(Action):
    async def run(self, outline: str):
        if not outline.strip():
            raise ValueError("å¤§çº²å†…å®¹ä¸ºç©º")
        return ""  # ä¸è¿”å›æ˜¾ç¤ºå†…å®¹

class GenerateIntro(Action):
    async def run(self, outline: str):
        prompt = f"""è¯·æ ¹æ®ä»¥ä¸‹é¡¹ç›®å¤§çº²ï¼Œç”Ÿæˆã€Šå¼•è¨€ã€‹éƒ¨åˆ†å†…å®¹ï¼Œä¸¥æ ¼éµå¾ª GB/T 8567-2006 æ ‡å‡†ï¼Œå†…å®¹éœ€è¯¦å°½ã€ä¸“ä¸šï¼Œé€‚åˆæ­£å¼çš„è½¯ä»¶éœ€æ±‚è§„æ ¼è¯´æ˜ä¹¦ã€‚è¾“å‡ºä½¿ç”¨ Markdown æ ¼å¼ï¼Œç›´æ¥å†™å†…å®¹ï¼ˆæ— éœ€ ```markdown```ï¼‰ï¼Œæ¯éƒ¨åˆ†å†…å®¹éœ€æ¸…æ™°ã€é€»è¾‘ä¸¥è°¨ï¼Œæ€»é•¿åº¦çº¦ 200-300 å­—ã€‚åŒ…æ‹¬ä»¥ä¸‹å­ç« èŠ‚ï¼š

1.1 æ ‡è¯†
- æä¾›ç³»ç»Ÿå’Œè½¯ä»¶çš„å®Œæ•´æ ‡è¯†ï¼ŒåŒ…æ‹¬ï¼š
  - æ ‡è¯†å·ï¼ˆå¦‚ SRS-XXX-001ï¼‰
  - æ ‡é¢˜ï¼ˆç³»ç»Ÿå…¨ç§°ï¼‰
  - ç¼©ç•¥è¯ï¼ˆå¦‚ ERPã€CRMï¼‰
  - ç‰ˆæœ¬å·ï¼ˆå¦‚ V1.0.0ï¼‰
  - å‘è¡Œå·ï¼ˆå¦‚ R1ï¼‰
- ç¤ºä¾‹ï¼šæ ‡è¯†å·ï¼šSRS-ERP-001ï¼›æ ‡é¢˜ï¼šä¼ä¸šèµ„æºè®¡åˆ’ç³»ç»Ÿï¼›ç¼©ç•¥è¯ï¼šERPï¼›ç‰ˆæœ¬å·ï¼šV1.0.0ï¼›å‘è¡Œå·ï¼šR1ã€‚

1.2 ç³»ç»Ÿæ¦‚è¿°
- è¯¦ç»†æè¿°ç³»ç»Ÿå’Œè½¯ä»¶çš„ç”¨é€”ï¼ˆå¦‚è§£å†³ä»€ä¹ˆé—®é¢˜ã€æä¾›ä»€ä¹ˆåŠŸèƒ½ï¼‰ã€‚
- è¯´æ˜ç³»ç»Ÿçš„ä¸€èˆ¬æ€§è´¨ï¼ˆå¦‚å®æ—¶æ€§ã€åˆ†å¸ƒå¼ï¼‰ã€‚
- æ¦‚è¿°å¼€å‘ã€è¿è¡Œå’Œç»´æŠ¤å†å²ï¼ˆå¦‚å¼€å‘èµ·å§‹æ—¶é—´ã€å½“å‰çŠ¶æ€ï¼‰ã€‚
- åˆ—å‡ºç›¸å…³æ–¹ï¼ˆå¦‚å¼€å‘å›¢é˜Ÿã€å®¢æˆ·ã€ç”¨æˆ·ç¾¤ä½“ï¼‰ã€‚
- æè¿°è¿è¡Œç°åœºï¼ˆå¦‚éƒ¨ç½²ç¯å¢ƒï¼šäº‘ç«¯ã€æœ¬åœ°æœåŠ¡å™¨ï¼‰ã€‚
- æåŠç›¸å…³æ–‡æ¡£ï¼ˆå¦‚ç”¨æˆ·æ‰‹å†Œã€è®¾è®¡æ–‡æ¡£ï¼‰ã€‚
- ç¤ºä¾‹ï¼š ä¼ä¸šèµ„æºè®¡åˆ’ç³»ç»Ÿæ—¨åœ¨ä¼˜åŒ–ä¼ä¸šèµ„æºç®¡ç†ï¼Œæ”¯æŒåº“å­˜ã€è´¢åŠ¡å’ŒäººåŠ›èµ„æºç®¡ç†ã€‚è¯¥ç³»ç»Ÿé‡‡ç”¨æ¨¡å—åŒ–è®¾è®¡ï¼Œè¿è¡Œäºäº‘ç«¯ï¼Œå¼€å‘å§‹äº2023å¹´ï¼Œå½“å‰ä¸ºBetaç‰ˆï¼Œè®¡åˆ’äº2025å¹´æ­£å¼å‘å¸ƒã€‚ä¸»è¦ç›¸å…³æ–¹åŒ…æ‹¬å¼€å‘å›¢é˜Ÿï¼ˆABCå…¬å¸ï¼‰ã€å®¢æˆ·ï¼ˆä¸­å°å‹ä¼ä¸šï¼‰å’Œæœ€ç»ˆç”¨æˆ·ï¼ˆè´¢åŠ¡äººå‘˜ï¼‰ã€‚è¿è¡ŒäºAWSäº‘ç«¯ï¼Œç›¸å…³æ–‡æ¡£åŒ…æ‹¬ã€Šç”¨æˆ·æ‰‹å†Œã€‹å’Œã€ŠAPIå‚è€ƒã€‹ã€‚

1.3 æ–‡æ¡£æ¦‚è¿°
- è¯´æ˜æœ¬æ–‡æ¡£çš„ç”¨é€”ï¼ˆå¦‚æŒ‡å¯¼å¼€å‘ã€æµ‹è¯•å’ŒéªŒè¯ï¼‰ã€‚
- æè¿°æ–‡æ¡£å†…å®¹ç»“æ„ï¼ˆç®€è¦æ¦‚è¿°å„ç« èŠ‚ï¼‰ã€‚
- æ˜ç¡®ä¿å¯†æ€§ä¸ç§å¯†æ€§è¦æ±‚ï¼ˆå¦‚ä»…é™å†…éƒ¨ä½¿ç”¨ã€éœ€ç­¾ç½²NDAï¼‰ã€‚
- ç¤ºä¾‹ï¼šæœ¬æ–‡æ¡£ä¸ºä¼ä¸šèµ„æºè®¡åˆ’ç³»ç»Ÿçš„éœ€æ±‚è§„æ ¼è¯´æ˜ä¹¦ï¼Œç”¨äºæŒ‡å¯¼å¼€å‘å’Œæµ‹è¯•å›¢é˜Ÿï¼Œç¡®ä¿ç³»ç»Ÿæ»¡è¶³å®¢æˆ·éœ€æ±‚ã€‚å†…å®¹åŒ…æ‹¬æ€»ä½“æè¿°ã€åŠŸèƒ½éœ€æ±‚ã€éåŠŸèƒ½éœ€æ±‚ç­‰ã€‚æ–‡æ¡£å±æœºå¯†ï¼Œä»…é™é¡¹ç›®ç›¸å…³æ–¹ä½¿ç”¨ï¼Œæœªç»æˆæƒä¸å¾—å¤–ä¼ ã€‚

è¦æ±‚ï¼š
- æ·±å…¥åˆ†æå¤§çº²ï¼Œæå–å…³é”®ä¿¡æ¯ï¼ˆå¦‚ç³»ç»Ÿåç§°ã€ç›®æ ‡ç”¨æˆ·ã€åŠŸèƒ½èŒƒå›´ï¼‰å¹¶èå…¥è¾“å‡ºã€‚
- ä½¿ç”¨æ­£å¼ã€ä¸“ä¸šçš„è¯­è¨€ï¼Œé¿å…å£è¯­åŒ–è¡¨è¾¾ã€‚
- ç¡®ä¿å†…å®¹é€»è¾‘æ¸…æ™°ï¼Œå±‚æ¬¡åˆ†æ˜ï¼Œé€‚åˆæŠ€æœ¯æ–‡æ¡£åœºæ™¯ã€‚

é¡¹ç›®å¤§çº²å¦‚ä¸‹ï¼š
{outline}
"""
        return await self._aask(prompt)

class GenerateOverallDesc(Action):
    async def run(self, outline: str):
        prompt = f"""è¯·æ ¹æ®ä»¥ä¸‹é¡¹ç›®å¤§çº²ï¼Œç”Ÿæˆã€Šæ€»ä½“æè¿°ã€‹ç« èŠ‚ï¼Œä¸¥æ ¼éµå¾ª GB/T 8567-2006 æ ‡å‡†ï¼Œå†…å®¹éœ€è¯¦å°½ã€ç»“æ„æ¸…æ™°ï¼Œé€‚åˆæ­£å¼çš„è½¯ä»¶éœ€æ±‚è§„æ ¼è¯´æ˜ä¹¦ã€‚è¾“å‡ºä½¿ç”¨ Markdown æ ¼å¼ï¼Œç›´æ¥å†™å†…å®¹ï¼ˆæ— éœ€ ```markdown```ï¼‰ï¼Œæ¯éƒ¨åˆ†å†…å®¹çº¦ 150-200 å­—ï¼Œæ€»é•¿åº¦çº¦ 600-800 å­—ã€‚åŒ…æ‹¬ä»¥ä¸‹å­ç« èŠ‚ï¼š

2.1 äº§å“è§†è§’
- æè¿°è½¯ä»¶åœ¨æ•´ä¸ªç³»ç»Ÿä¸­çš„ä½ç½®å’Œä½œç”¨ï¼ˆå¦‚æ ¸å¿ƒç»„ä»¶ã€ä¸ç¡¬ä»¶çš„äº¤äº’ï¼‰ã€‚
- è¯´æ˜è½¯ä»¶ä¸å…¶ä»–ç³»ç»Ÿçš„å…³ç³»ï¼ˆå¦‚é›†æˆç¬¬ä¸‰æ–¹æœåŠ¡ã€æ•°æ®äº¤äº’ï¼‰ã€‚
- ç¤ºä¾‹ï¼šä¼ä¸šèµ„æºè®¡åˆ’ç³»ç»Ÿæ˜¯ä¼ä¸šç®¡ç†å¹³å°çš„æ ¸å¿ƒï¼Œè´Ÿè´£åè°ƒåº“å­˜ã€è´¢åŠ¡å’ŒäººåŠ›èµ„æºæ¨¡å—ï¼Œä¸å¤–éƒ¨CRMç³»ç»Ÿé€šè¿‡APIé›†æˆï¼Œè¿è¡Œäºäº‘ç«¯æœåŠ¡å™¨ï¼Œæ”¯æŒå¤šç§Ÿæˆ·æ¶æ„ã€‚

2.2 äº§å“åŠŸèƒ½æ¦‚è¿°
- è¯¦ç»†æ¦‚è¿°è½¯ä»¶çš„ä¸»è¦åŠŸèƒ½ï¼ˆè‡³å°‘ 5-7 ä¸ªå…³é”®åŠŸèƒ½ï¼‰ã€‚
- ä½¿ç”¨ç®€æ´çš„æè¿°ï¼ŒæŒ‰ä¼˜å…ˆçº§æˆ–æ¨¡å—åˆ†ç»„ã€‚
- ç¤ºä¾‹ï¼š
  - åº“å­˜ç®¡ç†ï¼šå®æ—¶è·Ÿè¸ªåº“å­˜æ°´å¹³ï¼Œæ”¯æŒè‡ªåŠ¨è¡¥è´§ã€‚
  - è´¢åŠ¡ç®¡ç†ï¼šç”Ÿæˆè´¢åŠ¡æŠ¥è¡¨ï¼Œæ”¯æŒå¤šå¸ç§ç»“ç®—ã€‚
  - äººåŠ›èµ„æºç®¡ç†ï¼šç®¡ç†å‘˜å·¥æ¡£æ¡ˆã€è–ªèµ„å’Œè€ƒå‹¤ã€‚

2.3 ç”¨æˆ·ç‰¹å¾
- è¯¦ç»†æè¿°ç›®æ ‡ç”¨æˆ·çš„ç‰¹å¾ï¼ŒåŒ…æ‹¬ï¼š
  - ç”¨æˆ·è§’è‰²ï¼ˆå¦‚ç®¡ç†å‘˜ã€è´¢åŠ¡äººå‘˜ï¼‰ã€‚
  - æŠ€æœ¯æ°´å¹³ï¼ˆå¦‚ç†Ÿæ‚‰Excelã€æ— ç¼–ç¨‹ç»éªŒï¼‰ã€‚
  - ä½¿ç”¨åœºæ™¯ï¼ˆå¦‚åŠå…¬å®¤ã€ç§»åŠ¨ç«¯ï¼‰ã€‚
- ç¤ºä¾‹ï¼šç›®æ ‡ç”¨æˆ·åŒ…æ‹¬ä¸­å°å‹ä¼ä¸šçš„è´¢åŠ¡äººå‘˜ï¼ˆç†Ÿæ‚‰åŸºæœ¬åŠå…¬è½¯ä»¶ï¼‰ã€ä»“åº“ç®¡ç†å‘˜ï¼ˆéœ€ç®€å•ç•Œé¢ï¼‰å’Œé«˜ç®¡ï¼ˆéœ€æŠ¥è¡¨åˆ†æï¼‰ã€‚ä¸»è¦åœ¨åŠå…¬å®¤ä½¿ç”¨ï¼Œéƒ¨åˆ†åŠŸèƒ½æ”¯æŒç§»åŠ¨ç«¯ã€‚

2.4 å‡è®¾ä¸ä¾èµ–å…³ç³»
- åˆ—å‡ºç³»ç»Ÿè¿è¡Œçš„å‡è®¾ï¼ˆå¦‚ç¨³å®šçš„ç½‘ç»œè¿æ¥ã€ç”¨æˆ·åŸ¹è®­å®Œæˆï¼‰ã€‚
- æè¿°å¤–éƒ¨ä¾èµ–ï¼ˆå¦‚æ“ä½œç³»ç»Ÿã€æ•°æ®åº“ã€ç¬¬ä¸‰æ–¹APIï¼‰ã€‚
- ç¤ºä¾‹ï¼šå‡è®¾ç”¨æˆ·å®Œæˆç³»ç»ŸåŸ¹è®­ï¼Œç½‘ç»œå¸¦å®½ä¸ä½äº10Mbpsã€‚ä¾èµ–MySQLæ•°æ®åº“ã€AWSäº‘æœåŠ¡å’Œç¬¬ä¸‰æ–¹æ”¯ä»˜ç½‘å…³ï¼ˆå¦‚Stripeï¼‰ã€‚

è¦æ±‚ï¼š
- æ·±å…¥åˆ†æå¤§çº²ï¼Œæå–ç³»ç»Ÿç›®æ ‡ã€åŠŸèƒ½å’Œç”¨æˆ·ç­‰ä¿¡æ¯ï¼Œæ‰©å±•ä¸ºè¯¦ç»†æè¿°ã€‚
- ä½¿ç”¨ä¸“ä¸šæœ¯è¯­ï¼Œä¿æŒæŠ€æœ¯æ–‡æ¡£çš„æ­£å¼è¯­æ°”ã€‚
- ç¡®ä¿å†…å®¹å±‚æ¬¡åˆ†æ˜ï¼Œé€‚åˆå¼€å‘å’Œæµ‹è¯•äººå‘˜ä½¿ç”¨ã€‚

é¡¹ç›®å¤§çº²å¦‚ä¸‹ï¼š
{outline}
"""
        return await self._aask(prompt)

class GenerateFuncReq(Action):
    async def run(self, outline: str):
        prompt = f"""è¯·æ ¹æ®ä»¥ä¸‹é¡¹ç›®å¤§çº²ï¼Œç”Ÿæˆã€ŠåŠŸèƒ½éœ€æ±‚ã€‹ç« èŠ‚ï¼Œä¸¥æ ¼éµå¾ª GB/T 8567-2006 æ ‡å‡†ï¼Œå†…å®¹éœ€è¯¦ç»†ã€ç»“æ„æ¸…æ™°ï¼Œé€‚åˆå¼€å‘å’Œæµ‹è¯•äººå‘˜ä½¿ç”¨ã€‚è¾“å‡ºä½¿ç”¨ Markdown æ ¼å¼ï¼Œç›´æ¥å†™å†…å®¹ï¼ˆæ— éœ€ ```markdown```ï¼‰ï¼Œæ€»é•¿åº¦çº¦ 800-1000 å­—ã€‚ç»“æ„å¦‚ä¸‹ï¼š

- æ¯ä¸ªåŠŸèƒ½ç‚¹åŒ…æ‹¬ï¼š
  - åŠŸèƒ½æè¿°ï¼šè¯¦ç»†è¯´æ˜åŠŸèƒ½çš„ä½œç”¨å’Œç›®çš„ï¼ˆçº¦ 50-70 å­—ï¼‰ã€‚
  - è¾“å…¥/è¾“å‡ºè¯´æ˜ï¼šæè¿°ç”¨æˆ·è¾“å…¥å’Œç³»ç»Ÿè¾“å‡ºï¼ˆåŒ…æ‹¬æ ¼å¼ã€èŒƒå›´ï¼‰ã€‚
  - éªŒæ”¶æ ‡å‡†ï¼šæ˜ç¡®åŠŸèƒ½æˆåŠŸçš„æ ‡å‡†ï¼ˆå¯é‡åŒ–æˆ–å¯æµ‹è¯•ï¼‰ã€‚
  - ä¼˜å…ˆçº§ï¼šé«˜/ä¸­/ä½ã€‚
- è‡³å°‘ç”Ÿæˆ 5-7 ä¸ªåŠŸèƒ½ç‚¹ï¼ŒæŒ‰æ¨¡å—æˆ–ä¼˜å…ˆçº§åˆ†ç»„ã€‚

ç¤ºä¾‹ï¼š
### åŠŸèƒ½ 1ï¼šåº“å­˜æŸ¥è¯¢
- **åŠŸèƒ½æè¿°**ï¼šå…è®¸ç”¨æˆ·æŸ¥è¯¢æŒ‡å®šä»“åº“çš„åº“å­˜æ°´å¹³ï¼Œæ”¯æŒæŒ‰äº§å“ç±»åˆ«æˆ–æ‰¹æ¬¡è¿‡æ»¤ã€‚
- **è¾“å…¥/è¾“å‡ºè¯´æ˜**ï¼š
  - è¾“å…¥ï¼šäº§å“ç±»åˆ«ï¼ˆå¦‚â€œç”µå­äº§å“â€ï¼‰ã€æ‰¹æ¬¡å·ï¼ˆå¦‚â€œ2023-001â€ï¼‰ã€‚
  - è¾“å‡ºï¼šåº“å­˜åˆ—è¡¨ï¼ˆè¡¨æ ¼æ ¼å¼ï¼ŒåŒ…å«äº§å“IDã€åç§°ã€æ•°é‡ã€ä½ç½®ï¼‰ã€‚
- **éªŒæ”¶æ ‡å‡†**ï¼šæŸ¥è¯¢å“åº”æ—¶é—´å°äº2ç§’ï¼Œåˆ—è¡¨å‡†ç¡®åæ˜ æ•°æ®åº“ä¸­çš„æœ€æ–°åº“å­˜æ•°æ®ã€‚
- **ä¼˜å…ˆçº§**ï¼šé«˜

è¦æ±‚ï¼š
- æ·±å…¥åˆ†æå¤§çº²ï¼Œæå–å…³é”®åŠŸèƒ½å¹¶æ‰©å±•ä¸ºè¯¦ç»†æè¿°ã€‚
- ç¡®ä¿æ¯ä¸ªåŠŸèƒ½ç‚¹çš„æè¿°å…·ä½“ã€å¯æµ‹è¯•ï¼Œè¾“å…¥/è¾“å‡ºæ¸…æ™°ã€‚
- ä½¿ç”¨ä¸“ä¸šè¯­è¨€ï¼Œç»“æ„ä¸€è‡´ï¼Œé€‚åˆæŠ€æœ¯æ–‡æ¡£ã€‚

é¡¹ç›®å¤§çº²å¦‚ä¸‹ï¼š
{outline}
"""
        return await self._aask(prompt)

class GenerateNonFuncReq(Action):
    async def run(self, outline: str):
        prompt = f"""è¯·æ ¹æ®ä»¥ä¸‹é¡¹ç›®å¤§çº²ï¼Œç”Ÿæˆã€ŠéåŠŸèƒ½éœ€æ±‚ã€‹ç« èŠ‚ï¼Œä¸¥æ ¼éµå¾ª GB/T 8567-2006 æ ‡å‡†ï¼Œå†…å®¹éœ€è¯¦å°½ã€ä¸“ä¸šï¼Œé€‚åˆæ­£å¼çš„è½¯ä»¶éœ€æ±‚è§„æ ¼è¯´æ˜ä¹¦ã€‚è¾“å‡ºä½¿ç”¨ Markdown æ ¼å¼ï¼Œç›´æ¥å†™å†…å®¹ï¼ˆæ— éœ€ ```markdown```ï¼‰ï¼Œæ¯éƒ¨åˆ†çº¦ 100-150 å­—ï¼Œæ€»é•¿åº¦çº¦ 500-750 å­—ã€‚åŒ…æ‹¬ä»¥ä¸‹å­ç« èŠ‚ï¼š

- æ€§èƒ½éœ€æ±‚
  - æè¿°ç³»ç»Ÿæ€§èƒ½è¦æ±‚ï¼ˆå¦‚å“åº”æ—¶é—´ã€ååé‡ã€å¹¶å‘ç”¨æˆ·æ•°ï¼‰ã€‚
  - ç¤ºä¾‹ï¼šç³»ç»Ÿéœ€æ”¯æŒ1000å¹¶å‘ç”¨æˆ·ï¼Œé¡µé¢åŠ è½½æ—¶é—´ä¸è¶…è¿‡2ç§’ï¼Œæ‰¹é‡æ•°æ®å¤„ç†æ¯åˆ†é’Ÿ1000æ¡è®°å½•ã€‚

- å®‰å…¨æ€§
  - è¯´æ˜æ•°æ®ä¿æŠ¤ã€è®¿é—®æ§åˆ¶å’Œè®¤è¯è¦æ±‚ã€‚
  - ç¤ºä¾‹ï¼šæ”¯æŒSSOç™»å½•ï¼Œæ‰€æœ‰æ•°æ®ä¼ è¾“ä½¿ç”¨TLS 1.3åŠ å¯†ï¼Œæ•æ„Ÿæ•°æ®ï¼ˆå¦‚è–ªèµ„ï¼‰éœ€å­—æ®µçº§åŠ å¯†ã€‚

- å¯ç”¨æ€§
  - å®šä¹‰ç³»ç»Ÿå¯ç”¨æ€§ç›®æ ‡ï¼ˆå¦‚å¹´å¯ç”¨æ€§ç™¾åˆ†æ¯”ã€æ•…éšœæ¢å¤æ—¶é—´ï¼‰ã€‚
  - ç¤ºä¾‹ï¼šç³»ç»Ÿå¹´å¯ç”¨æ€§è¾¾99.9%ï¼Œå¹³å‡æ•…éšœæ¢å¤æ—¶é—´ï¼ˆMTTRï¼‰å°äº1å°æ—¶ã€‚

- å¯ç»´æŠ¤æ€§
  - æè¿°ç³»ç»Ÿç»´æŠ¤çš„ä¾¿æ·æ€§ï¼ˆå¦‚æ—¥å¿—è®°å½•ã€æ¨¡å—åŒ–è®¾è®¡ï¼‰ã€‚
  - ç¤ºä¾‹ï¼šç³»ç»Ÿæä¾›è¯¦ç»†é”™è¯¯æ—¥å¿—ï¼Œæ”¯æŒçƒ­æ›´æ–°ï¼Œæ¨¡å—åŒ–è®¾è®¡ä¾¿äºåŠŸèƒ½æ‰©å±•ã€‚

- å¯ç§»æ¤æ€§
  - è¯´æ˜ç³»ç»Ÿåœ¨ä¸åŒç¯å¢ƒä¸‹çš„å…¼å®¹æ€§ï¼ˆå¦‚æ“ä½œç³»ç»Ÿã€äº‘å¹³å°ï¼‰ã€‚
  - ç¤ºä¾‹ï¼šç³»ç»Ÿå…¼å®¹Windowså’ŒLinuxæœåŠ¡å™¨ï¼Œæ”¯æŒAWSå’ŒAzureäº‘éƒ¨ç½²ã€‚

è¦æ±‚ï¼š
- æ·±å…¥åˆ†æå¤§çº²ï¼Œæå–ç³»ç»Ÿç‰¹æ€§å¹¶æ‰©å±•ä¸ºè¯¦ç»†æè¿°ã€‚
- ä½¿ç”¨é‡åŒ–æŒ‡æ ‡ï¼ˆå¦‚æ—¶é—´ã€ç™¾åˆ†æ¯”ï¼‰å¢å¼ºå¯æµ‹è¯•æ€§ã€‚
- ä¿æŒä¸“ä¸šè¯­æ°”ï¼Œå†…å®¹é€‚åˆæŠ€æœ¯æ–‡æ¡£åœºæ™¯ã€‚

é¡¹ç›®å¤§çº²å¦‚ä¸‹ï¼š
{outline}
"""
        return await self._aask(prompt)

class GenerateInterfaces(Action):
    async def run(self, outline: str):
        prompt = f"""è¯·æ ¹æ®ä»¥ä¸‹é¡¹ç›®å¤§çº²ï¼Œç”Ÿæˆã€Šå¤–éƒ¨æ¥å£éœ€æ±‚ã€‹ç« èŠ‚ï¼Œä¸¥æ ¼éµå¾ª GB/T 8567-2006 æ ‡å‡†ï¼Œå†…å®¹éœ€è¯¦å°½ã€ç»“æ„æ¸…æ™°ï¼Œé€‚åˆæ­£å¼çš„è½¯ä»¶éœ€æ±‚è§„æ ¼è¯´æ˜ä¹¦ã€‚è¾“å‡ºä½¿ç”¨ Markdown æ ¼å¼ï¼Œç›´æ¥å†™å†…å®¹ï¼ˆæ— éœ€ ```markdown```ï¼‰ï¼Œæ¯éƒ¨åˆ†çº¦ 100-150 å­—ï¼Œæ€»é•¿åº¦çº¦ 400-600 å­—ã€‚åŒ…æ‹¬ä»¥ä¸‹å­ç« èŠ‚ï¼š

- ç”¨æˆ·æ¥å£
  - æè¿°ç”¨æˆ·äº¤äº’ç•Œé¢ï¼ˆå¦‚GUIã€CLIã€ç§»åŠ¨ç«¯ï¼‰ã€‚
  - ç¤ºä¾‹ï¼šç³»ç»Ÿæä¾›åŸºäºWebçš„GUIï¼Œæ”¯æŒå“åº”å¼è®¾è®¡ï¼Œå…¼å®¹ä¸»æµæµè§ˆå™¨ï¼ˆChromeã€Firefoxï¼‰ã€‚ç§»åŠ¨ç«¯æ”¯æŒiOSå’ŒAndroidåŸç”Ÿåº”ç”¨ã€‚

- ç¡¬ä»¶æ¥å£
  - è¯´æ˜ä¸ç¡¬ä»¶è®¾å¤‡çš„äº¤äº’ï¼ˆå¦‚ä¼ æ„Ÿå™¨ã€æ‰“å°æœºï¼‰ã€‚
  - ç¤ºä¾‹ï¼šç³»ç»Ÿé€šè¿‡USBæ¥å£ä¸æ¡ç æ‰«æå™¨é€šä¿¡ï¼Œæ”¯æŒZebraç³»åˆ—è®¾å¤‡ï¼Œæ•°æ®ä¼ è¾“é€Ÿç‡è¾¾480Mbpsã€‚

- è½¯ä»¶æ¥å£
  - æè¿°ä¸å¤–éƒ¨è½¯ä»¶çš„äº¤äº’ï¼ˆå¦‚APIã€æ•°æ®åº“ï¼‰ã€‚
  - ç¤ºä¾‹ï¼šç³»ç»Ÿé€šè¿‡RESTful APIä¸CRMç³»ç»Ÿé›†æˆï¼Œæ”¯æŒJSONæ ¼å¼ï¼ŒAPIå“åº”æ—¶é—´å°äº500msã€‚

- é€šè®¯æ¥å£
  - è¯´æ˜ç½‘ç»œé€šä¿¡åè®®å’Œè¦æ±‚ï¼ˆå¦‚HTTPã€MQTTï¼‰ã€‚
  - ç¤ºä¾‹ï¼šç³»ç»Ÿä½¿ç”¨HTTPSåè®®ä¸äº‘æœåŠ¡å™¨é€šä¿¡ï¼Œæ”¯æŒWebSocketè¿›è¡Œå®æ—¶æ•°æ®æ›´æ–°ï¼Œå¸¦å®½éœ€æ±‚ä¸ä½äº10Mbpsã€‚

è¦æ±‚ï¼š
- æ·±å…¥åˆ†æå¤§çº²ï¼Œæå–æ¥å£ç›¸å…³ä¿¡æ¯å¹¶æ‰©å±•ä¸ºè¯¦ç»†æè¿°ã€‚
- ä½¿ç”¨æŠ€æœ¯æœ¯è¯­ï¼Œæ˜ç¡®åè®®ã€æ ¼å¼å’Œæ€§èƒ½è¦æ±‚ã€‚
- ä¿æŒä¸“ä¸šè¯­æ°”ï¼Œå†…å®¹é€‚åˆæŠ€æœ¯æ–‡æ¡£åœºæ™¯ã€‚

é¡¹ç›®å¤§çº²å¦‚ä¸‹ï¼š
{outline}
"""
        return await self._aask(prompt)

# å®šä¹‰éœ€æ±‚æ–‡æ¡£ç”Ÿæˆçš„è§’è‰²
class ReqDocAgent(Role):
    def __init__(self, **kwargs):
        super().__init__(**kwargs)
        self.set_actions([
            ParseOutline(),
            GenerateIntro(),
            GenerateOverallDesc(),
            GenerateFuncReq(),
            GenerateNonFuncReq(),
            GenerateInterfaces()
        ])

    async def _act(self) -> Message:
        msg = self.rc.memory.get()[-1]
        result = msg.content
        combined_result = ""

        for action in self.actions:
            if isinstance(action, ParseOutline):
                await action.run(result)  # è¿è¡Œä½†ä¸ä¿å­˜è¾“å‡º
                continue
            part = await action.run(result)
            combined_result += f"{part.strip()}\n\n"

        return Message(content=combined_result, role=self.profile)

# Streamlit åº”ç”¨ç•Œé¢
st.title("ğŸ“ æ–‡æ¡£æ’°å†™Agent")

uploaded_file = st.file_uploader("ä¸Šä¼ é¡¹ç›®å¤§çº²æ–‡ä»¶ï¼ˆ.txt æˆ– .mdï¼‰", type=("txt", "md"))
generate_button = st.button("ç”Ÿæˆéœ€æ±‚æ–‡æ¡£")

if uploaded_file and generate_button:
    content = uploaded_file.read().decode('utf-8')
    if not content.strip():
        st.error("ä¸Šä¼ çš„æ–‡ä»¶å†…å®¹ä¸ºç©ºï¼Œè¯·ä¸Šä¼ æœ‰æ•ˆçš„å¤§çº²æ–‡ä»¶ã€‚")
    else:
        try:
            agent = ReqDocAgent()
            result = asyncio.run(agent.run(Message(content=content)))
            st.success("âœ… æˆåŠŸç”Ÿæˆéœ€æ±‚æ–‡æ¡£")
            st.download_button(
                label="ğŸ“¥ ä¸‹è½½éœ€æ±‚æ–‡æ¡£",
                data=result.content,
                file_name="éœ€æ±‚è§„æ ¼è¯´æ˜ä¹¦.md",
                mime="text/markdown"
            )
            st.markdown("### ğŸ“„ ç”Ÿæˆçš„éœ€æ±‚æ–‡æ¡£é¢„è§ˆ")
            st.markdown(result.content)
        except Exception as e:
            logger.error(f"æ‰§è¡Œå¤±è´¥: {str(e)}")
            st.error(f"æ‰§è¡Œå¤±è´¥: {str(e)}")